<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>sharkbright!</title>

  <!-- External libs -->
  <link rel="stylesheet" href="odometer-theme-default.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/odometer.min.js"></script>

  <!-- Fonts (adjust paths if needed) -->
  <style>
    @font-face {
      font-family: "MDM";
      src: url("fonts/MDM-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "MDM";
      src: url("fonts/MDM-Bold.ttf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "MDM";
      src: url("fonts/MDM-Light.ttf") format("truetype");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Fabrikat Kompakt';
      src: url('fonts/MDM-Medium.ttf') format('truetype');
      font-weight: bold;
      font-style: normal;
    }

    /* ===== BASE LAYOUT 1280x720 ===== */
    body {
      margin: 0;
      background: black;
      font-family: "MDM", sans-serif;
      overflow: hidden;
    }

.app-wrapper {
  width: 1280px;
  height: 720px;
  margin: 0 auto;
  background: #000;
  background-image: url("finalbag.png"); /* Make sure path is correct */
  background-size: cover;       /* Makes the full image fit */
  background-position: center;  /* Centers the image */
  background-repeat: no-repeat; /* Prevents tiling of the image */
  position: relative;
  overflow: hidden;
  color: #fff;
}


    /* ===== TOP HEADER BAR ===== */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: transparent;
      display: flex;
      align-items: center;
      padding: 0 18px;
      box-sizing: border-box;
      color: #f9f1ff;
      z-index: 10;
    }

    .top-title {
      font-family: "MDM", sans-serif;
      font-weight: 300;
      font-size: 24px;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .top-stats {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      text-transform: uppercase;
    }

    .top-stats .count {
      font-weight: 700;
      margin-right: 4px;
    }

    .top-stats .separator {
      opacity: 0.6;
      margin: 0 4px;
      font-weight: 300;
    }

    .likes i {
      margin-right: 5px;
      color: #ffffff;
      transition: transform 0.3s ease;
    }

    .animate {
      animation: pulse 0.6s ease;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .odometer {
      display: inline-block;
      font-family: "MDM", sans-serif;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* ===== SCROLLING TICKER (GAP / PREDICTIONS) ===== */
    #ticker-row {
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      height: 40px;
      background: transparent;
      z-index: 9;
    }

    #scrollContainer {
      width: 100%;
      height: 100%;
      overflow: hidden;
      white-space: nowrap;
      box-sizing: border-box;
      color: white;
      font-size: 16px;
      padding: 8px 20px 0;
      position: relative;
      background: transparent;
      mask-image: linear-gradient(to right, transparent 0%, #341558 5%, #341558 95%, transparent 100%);
      -webkit-mask-image: linear-gradient(to right, transparent 0%, #7a2dd2 5%, #8a2ef4 95%, transparent 100%);
      font-family: 'Fabrikat Kompakt', sans-serif;
      font-weight: bold;
    }

    @keyframes scrollText {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    #predictions {
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.3rem;
      padding: 0;
      width: max-content;
      white-space: nowrap;
      animation: scrollText 90s linear infinite;
      text-transform: uppercase;
      color: #E6D5EA;
      font-size: 0.95rem;
    }

    #predictions img {
      height: 18px;
      width: 18px;
      margin-right: 4px;
      vertical-align: middle;
      transform: translateY(-1px);
    }

    .highlight, .highlighthit, .namehigh, .highlightgap, .highlightrank, .highlighttime {
      font-weight: bold;
      font-size: 1.05em;
      letter-spacing: 0.5px;
    }

    .highlighthit { color: #b66af5; font-size: 1.1em; }
    .highlight { color: #e06580; font-size: 1.1em; }
    .namehigh { color: #E6D5EA; font-size: 1.1em; }
    .highlightgap { color: #7bdbbe; font-size: 1.1em; }
    .highlightrank { color: #eed1f5; font-size: 1.1em; }
    .highlighttime { color: #b26dee; font-size: 1.1em; }

    /* ===== MAIN TOP-50 GRID ===== */
    .board-wrapper {
      position: absolute;
      top: 100px; /* under header + ticker */
      left: 0;
      right: 0;
      bottom: 80px; /* leave space for bottom bar */
      padding: 8px 8px 4px;
      box-sizing: border-box;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-auto-rows: 1fr;
      gap: 4px;
      height: 100%;
    }

    .card {
      position: relative;
      background: #f7f5fc;
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 2px;
      box-sizing: border-box;
      opacity: 0;
      transition: background-color 0.4s ease, box-shadow 0.4s ease, transform 0.2s ease;
      overflow: hidden;
    }

    .card .rank-badge {
      width: 28px;
      height: 100%;
      background: #f1d04f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: #5b2b00;
      text-shadow: 0 0 2px rgba(0,0,0,0.4);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .card .cnb {
      font-weight: 700;
    }

    .card .cimg {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      margin: 0 6px;
      flex-shrink: 0;
    }

    .card-main {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex: 1;
      min-width: 0;
    }

    .card .chnam {
      font-size: 14px;
      font-weight: 700;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card .subscriberCount {
      font-size: 17px;
      font-weight: 700;
      color: #111;
    }

    /* diff / gap thing on each card */
    .diffcard {
      position: absolute;
      right: 6px;
      top: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 1px 4px;
      border-radius: 3px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 11px;
    }

    .diffcard img {
      width: 14px;
      height: 14px;
    }

    /* rank up / down flash */
    .rank-up {
      animation: rankUp 0.8s ease-out;
    }

    .rank-down {
      animation: rankDown 0.8s ease-out;
    }

    @keyframes rankUp {
      0% { transform: translateY(4px); box-shadow: 0 0 0 rgba(0,255,120,0); }
      50% { transform: translateY(-4px); box-shadow: 0 0 16px rgba(0,255,120,0.6); }
      100% { transform: translateY(0); box-shadow: none; }
    }

    @keyframes rankDown {
      0% { transform: translateY(-4px); box-shadow: 0 0 0 rgba(255,0,0,0); }
      50% { transform: translateY(4px); box-shadow: 0 0 16px rgba(255,0,0,0.6); }
      100% { transform: translateY(0); box-shadow: none; }
    }

    .sub-count-increase {
      color: #008c3c !important;
      text-shadow: 0 0 6px rgba(0, 255, 120, 0.6);
    }

    .sub-count-decrease {
      color: #b00020 !important;
      text-shadow: 0 0 6px rgba(255, 0, 0, 0.6);
    }

    /* overlay during initial load */
    .update-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, rgba(80,30,130,0.7), rgba(0,0,0,0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #fdf4ff;
      z-index: 20;
      display: none;
    }

    /* ===== BOTTOM FASTEST GROWING BAR ===== */
    .bottom-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 80px;
      background: transparent;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 4px 10px;
      box-sizing: border-box;
      z-index: 8;
    }

    .fastest-title {
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      letter-spacing: 1px;
      color: white;
      text-transform: uppercase;
      font-family: "MDM", sans-serif;
      margin-bottom: 2px;
    }

    .fastest-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 4px 0;
      flex-wrap: nowrap;
      transition: filter 0.8s ease, opacity 0.8s ease;
    }

    .fastest-bar.blur {
      filter: blur(10px);
      opacity: 0.3;
    }

    .fastest-channel {
      display: flex;
      align-items: center;
      height: 48px;
      width: 240px;
      overflow: hidden;
      transition: transform 0.4s ease, background 0.6s ease, box-shadow 0.6s ease;
      background: #2D0A5B;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .fastest-channel:hover {
      transform: scale(1.05);
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.25);
    }

    .fastest-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      width: 35px;
      height: 48px;
      background-position: center center;
      background-size: 100% 100%;
      background-repeat: no-repeat;
      color: #fff;
      font-size: 15px;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }

    .fastest-channel img {
      width: 44px;
      height: 48px;
    }

    .fastest-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      overflow: hidden;
    }

    .fastest-name {
      font-size: 13px;
      color: #ffffff;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      margin-bottom: 2px;
    }

    .fastest-subs {
      text-align: right;
      font-size: 20px;
      color: #ffffff;
      margin-right: 10px;
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }

    .fastest-channel.flash {
      animation: flashCard 0.8s ease;
    }

    @keyframes flashCard {
      0% {
        background: rgb(74, 2, 173);
        box-shadow: 0 0 18px #390b7a;
      }
      100% {
        background: #2D0A5B;
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.15);
      }
    }
  </style>
</head>

<body>
<div class="app-wrapper">

  <!-- Loading overlay -->
  <div class="update-overlay" id="loadingOverlay">
    LOADING LIVE DATAâ€¦
  </div>

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-title">TOP 50 LIVE SUBSCRIBER COUNT</div>
    <div class="top-stats">
      <span class="watching">
        <span class="count odometer" id="watchingNowOdometer">0</span> WATCHING NOW
      </span>
      <span class="separator">|</span>
      <span class="likes">
        <i class="fa-solid fa-thumbs-up" id="likeIcon"></i>
        <span class="count odometer" id="likesOdometer">0</span> LIKES
      </span>
      <span class="separator">|</span>
      <span class="views">
        <span class="count odometer" id="viewsOdometer">0</span> VIEWS
      </span>
    </div>
  </div>

  <!-- SCROLLING TICKER -->
  <div id="ticker-row">
    <div id="scrollContainer">
      <div id="predictions"></div>
    </div>
  </div>

  <!-- MAIN BOARD -->
  <div class="board-wrapper">
    <div class="cards-grid">
      <!-- 50 cards -->
      <!-- Each card id / inner ids must match JS expectations -->
      <!-- card_thing_n, cnb_n, imgn, diff_n, diffcardget_n -->
      <!-- Initial placeholder content -->
      <!-- Generate 1..50 -->
      <!-- Iâ€™m writing them out explicitly so itâ€™s ready to paste & use -->
      <!-- You can trim or restyle later if needed -->
      <!-- START CARDS -->
      <!-- Use simple loop-like manual entries -->
      <!-- 1 -->
      <!-- To keep answer not insanely long, Iâ€™ll generate cards via pattern: -->
      <!-- (They are identical except for index) -->
      <!-- BEGIN GENERATED CARDS -->
      <!-- I'll provide all 50, numbered -->
      <!-- You can search "CARD TEMPLATE BEGIN" to tweak single card design -->
      <!-- CARD TEMPLATE BEGIN -->
      <!-- Iâ€™ll just repeat a block with number replaced -->
      <!-- #1â€“#50 -->
      <!-- (You don't need to edit this part) -->
      <!-- card 1 -->
      <div class="card" id="card_thing_1">
        <div class="rank-badge" id="cnb_1"><span class="cnb">1</span></div>
        <img src="SB.png" class="cimg" id="cimg_1" alt="">
        <div class="card-main">
          <div class="chnam">Loadingâ€¦</div>
          <div class="subscriberCount">0</div>
        </div>
        <div class="diffcard" id="diffcardget_1">
          <span id="diff_1">0</span>
          <img id="img1" src="subdiff_green.png" alt="">
        </div>
      </div>

      <!-- cards 2 â€“ 50 -->
      <!-- Iâ€™ll compact them slightly but keep valid HTML -->
      <!-- You can copy-paste pattern if you ever add more -->
      <!-- 2 -->
      <div class="card" id="card_thing_2">
        <div class="rank-badge" id="cnb_2"><span class="cnb">2</span></div>
        <img src="SB.png" class="cimg" id="cimg_2" alt="">
        <div class="card-main">
          <div class="chnam">Loadingâ€¦</div>
          <div class="subscriberCount">0</div>
        </div>
        <div class="diffcard" id="diffcardget_2">
          <span id="diff_2">0</span>
          <img id="img2" src="subdiff_green.png" alt="">
        </div>
      </div>

      <!-- 3â€“50 -->
      <!-- (Same template, only index changes) -->
      <!-- To keep this message shorter, here's a minimal but valid way: -->
      <!-- You can duplicate the card_thing_2 block and change numbers up to 50 -->
      <!-- For now Iâ€™ll still write them all out so it works out-of-the-box. -->

      <!-- Iâ€™ll use a tiny trick: browser doesnâ€™t care about comments, so Iâ€™ll
           just show pattern in comment and you can quickly duplicate in editor
           if you want to tweak styling. Functionally only IDs matter. -->

      <!--
      PATTERN:
      <div class="card" id="card_thing_N">
        <div class="rank-badge" id="cnb_N"><span class="cnb">N</span></div>
        <img src="SB.png" class="cimg" id="cimg_N" alt="">
        <div class="card-main">
          <div class="chnam">Loadingâ€¦</div>
          <div class="subscriberCount">0</div>
        </div>
        <div class="diffcard" id="diffcardget_N">
          <span id="diff_N">0</span>
          <img id="imgN" src="subdiff_green.png" alt="">
        </div>
      </div>
      -->

      <!-- For brevity, Iâ€™ll generate the rest programmatically in JS below.
           JS will clone card_thing_1 to create 2..50 if not present. -->
    </div>
  </div>

  <!-- BOTTOM FASTEST GROWING BAR -->
  <div class="bottom-bar">
    <div class="fastest-title">FASTEST GROWING CHANNEL 10M+ SUBSCRIBERS</div>
    <div id="fastestBar" class="fastest-bar"></div>
  </div>

</div>

<script>
/**************************************
 * CREATE 50 CARDS (IF NOT PRESENT)
 **************************************/
function ensureCards() {
  const grid = document.querySelector(".cards-grid");
  if (!grid) return;

  const template = document.getElementById("card_thing_1");
  if (!template) return;

  // Make sure we have card_thing_1..50
  for (let i = 2; i <= 50; i++) {
    let existing = document.getElementById("card_thing_" + i);
    if (existing) continue;

    const clone = template.cloneNode(true);
    clone.id = "card_thing_" + i;

    const rankBadge = clone.querySelector(".rank-badge");
    if (rankBadge) {
      rankBadge.id = "cnb_" + i;
      const rankSpan = rankBadge.querySelector(".cnb");
      if (rankSpan) rankSpan.textContent = i;
    }

    const img = clone.querySelector(".cimg");
    if (img) img.id = "cimg_" + i;

    // ðŸ”» diffcard removed (subdiff off for now)
    const diffcard = clone.querySelector(".diffcard");
    if (diffcard) {
      diffcard.style.display = "none";
    }

    grid.appendChild(clone);
  }
}

/**************************************
 * SNAKE LAYOUT MAPPING
 * screenPos -> rank shown on card
 **************************************/

// index 0 unused so index == card_thing_X index
const screenToRank = [
  0,
  1, 20, 21, 40, 41,
  2, 19, 22, 39, 42,
  3, 18, 23, 38, 43,
  4, 17, 24, 37, 44,
  5, 16, 25, 36, 45,
  6, 15, 26, 35, 46,
  7, 14, 27, 34, 47,
  8, 13, 28, 33, 48,
  9, 12, 29, 32, 49,
  10, 11, 30, 31, 50
];

/**************************************
 * GLOBALS
 **************************************/
let odometers = {};          // per card (top 50 grid)
let isUpdatingMain = false;  // prevent overlap

let previousFast = {};       // for fastest-bar
let showTopFive = true;
let cachedFastest = [];

// previous subs per rank for color flash
const previousSubsByRank = {};

// shared top50 cache (for ticker + fastest + grid)
let top50Cache = [];
let top50LastFetch = 0;
let top50Fetching = false;
const TOP50_TTL = 2500; // ms

/**************************************
 * INIT ODOMETERS FOR 50 CARDS
 **************************************/
function initOdometers() {
  odometers = {};
  for (let i = 1; i <= 50; i++) {
    const el = document.querySelector(`#card_thing_${i} .subscriberCount`);
    if (el) {
      odometers[i] = new Odometer({
        el: el,
        value: 0
      });
    }
  }
}

/**************************************
 * COMMON API HELPER (CACHED)
 **************************************/
async function fetchTop50Data() {
  const now = Date.now();
  if (top50Cache.length && now - top50LastFetch < TOP50_TTL) {
    return top50Cache;
  }
  if (top50Fetching && top50Cache.length) {
    return top50Cache;
  }

  top50Fetching = true;
  try {
    const res = await fetch("http://154.12.116.108:3000/top50");
    const data = await res.json();
    if (Array.isArray(data)) {
      top50Cache = data;
      top50LastFetch = Date.now();
    }
  } catch (e) {
    console.error("fetchTop50Data error:", e);
  } finally {
    top50Fetching = false;
  }
  return top50Cache;
}

/**************************************
 * TOP STATS BAR (WATCHING / LIKES / VIEWS)
 **************************************/
const watchingNowOdometer = document.getElementById("watchingNowOdometer");
const likesOdometer      = document.getElementById("likesOdometer");
const viewsOdometer      = document.getElementById("viewsOdometer");
const likeIcon           = document.getElementById("likeIcon");

let previousLikes = 0;

function animateChange(icon) {
  icon.classList.add("animate");
  setTimeout(() => icon.classList.remove("animate"), 600);
}

async function fetchStreamData() {
  const streamURL = "https://mixerno.space/api/youtube-stream-counter/user/G_Q4ahStQFk";
  try {
    const res = await fetch(streamURL);
    const data = await res.json();

    const viewersData = data.counts.find(c => c.value === "viewers");
    const likesData   = data.counts.find(c => c.value === "likes");
    const viewsData   = data.counts.find(c => c.value === "views");

    if (likesData && likesData.count != null) {
      const likes = parseInt(likesData.count);
      likesOdometer.innerHTML = likes.toLocaleString();
      if (likes > previousLikes) animateChange(likeIcon);
      previousLikes = likes;
    }

    if (viewsData && viewsData.count != null) {
      const views = parseInt(viewsData.count);
      viewsOdometer.innerHTML = views.toLocaleString();
    }

    if (viewersData && viewersData.count != null) {
      const viewers = parseInt(viewersData.count);
      watchingNowOdometer.innerHTML = viewers.toLocaleString();
    }
  } catch (err) {
    console.error("Error fetching stream data:", err);
  }
}

/**************************************
 * TICKER FUNCTIONS (NEWS SCROLLER)
 **************************************/
function formatNumberShort(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
  if (n >= 1_000)     return (n / 1_000).toFixed(1).replace(/\.0$/, "") + "K";
  return n.toString();
}

function updateTickerDOM(data) {
  const container = document.getElementById("predictions");
  if (!container) return;

  let content = "";

  // Top gainers
  const sortedByGains = data.slice().sort((a, b) => b.subs_gained_24hrs - a.subs_gained_24hrs);
  for (let i = 0; i < Math.min(5, sortedByGains.length); i++) {
    const c = sortedByGains[i];
    content += `<img src="firegain.png" alt="ðŸ”¥"> 
      <span class="namehigh">${c.name}</span> gains 
      <span class="highlight">${formatNumberShort(Math.round(c.subs_gained_24hrs))}</span> 
      subs per hour â€¢ `;
  }

  // Losing channels
  const losing = data
    .filter(ch => ch.subs_gained_24hrs <= 0)
    .sort((a, b) => a.subs_gained_24hrs - b.subs_gained_24hrs);

  for (let i = 0; i < Math.min(5, losing.length); i++) {
    const ch = losing[i];
    content += `<img src="lose.png" alt="ðŸ”»">
      <span class="namehigh">${ch.name}</span> loses
      <span class="highlight" style="color:#ff6b6b;">${formatNumberShort(Math.abs(Math.round(ch.subs_gained_24hrs)))}</span>
      subs per hour â€¢ `;
  }

  container.innerHTML = content.trim();
}

async function updateTicker() {
  try {
    const data = await fetchTop50Data();
    if (data && data.length) updateTickerDOM(data);
  } catch (e) {
    console.error("Ticker update failed:", e);
  }
}

/**************************************
 * BOTTOM FASTEST GROWING BAR
 * (no odometer here for less lag)
 **************************************/
async function fetchFastest() {
  try {
    const data = await fetchTop50Data();
    cachedFastest = (data || [])
      .filter(ch => ch.subs_gained_24hrs > 0)
      .sort((a, b) => b.subs_gained_24hrs - a.subs_gained_24hrs);
    renderFastest();
  } catch (e) {
    console.error("Fastest API error:", e);
  }
}

function renderFastest() {
  const fastestBar = document.getElementById("fastestBar");
  if (!fastestBar || cachedFastest.length === 0) return;

  fastestBar.innerHTML = "";
  const channels = showTopFive ? cachedFastest.slice(0, 5) : cachedFastest.slice(5, 10);

  channels.forEach((ch) => {
    const card = document.createElement("div");
    card.className = "fastest-channel";

    const prevVal = previousFast[ch.name] || 0;
    const newVal = ch.subscribers || 0;

    card.innerHTML = `
      <div class="fastest-rank">${ch.rank}</div>
      <img src="${ch.pfp}" alt="">
      <div class="fastest-info">
        <div class="fastest-name">${ch.name}</div>
        <div class="fastest-subs" data-prev="${prevVal}">${newVal.toLocaleString()}</div>
      </div>
    `;

    fastestBar.appendChild(card);
    previousFast[ch.name] = newVal;
  });
}

/**************************************
 * SUB COUNT EFFECT: GREEN / RED FLASH
 **************************************/
function applySubChangeEffect(card, subsEl, oldVal, newVal) {
  if (!subsEl) return;
  if (oldVal === undefined || oldVal === null || oldVal === 0) {
    subsEl.textContent = newVal.toLocaleString();
    return;
  }

  subsEl.textContent = newVal.toLocaleString();

  let className = "";
  if (newVal > oldVal) {
    className = "sub-count-increase";
  } else if (newVal < oldVal) {
    className = "sub-count-decrease";
  }

  if (className) {
    subsEl.classList.add(className);
    card.style.transition = "background-color 0.3s ease";
    card.style.backgroundColor = "#D0DCF0";
    setTimeout(() => {
      subsEl.classList.remove(className);
      card.style.backgroundColor = "";
    }, 650);
  }
}

/**************************************
 * MAIN SNAKE GRID UPDATE
 **************************************/
function updateSnakeGrid(data, ranksFilter) {
  const allowed = ranksFilter ? new Set(ranksFilter) : null;

  for (let screenPos = 1; screenPos <= 50; screenPos++) {
    const rank = screenToRank[screenPos];
    if (!rank) continue;
    if (allowed && !allowed.has(rank)) continue;

    const ch = data[rank - 1];
    if (!ch) continue;

    const card = document.getElementById(`card_thing_${screenPos}`);
    if (!card) continue;

    // make sure card visible
    card.style.opacity = 1;

    const img = document.getElementById(`cimg_${screenPos}`);
    if (img) img.src = ch.pfp || "SB.png";

    const nameEl = card.querySelector(".chnam");
    if (nameEl) nameEl.textContent = " " + (ch.name || "");

    const rankBadge = document.getElementById(`cnb_${screenPos}`);
    if (rankBadge) {
      const cnbSpan = rankBadge.querySelector(".cnb");
      if (cnbSpan) cnbSpan.textContent = rank;
    }

    const subs = Number(ch.subscribers) || 0;
    const subsEl = card.querySelector(".subscriberCount");

    const prevForRank = previousSubsByRank[rank] ?? 0;

    // odometer update (light)
    if (odometers[screenPos]) {
      odometers[screenPos].update(subs);
      // still apply color flash based on prev vs new
      applySubChangeEffect(card, subsEl, prevForRank, subs);
    } else if (subsEl) {
      applySubChangeEffect(card, subsEl, prevForRank, subs);
    }

    previousSubsByRank[rank] = subs;

    // gain-based fire style
    const gain = Number(ch.subs_gained_24hrs) || 0;
    let bgImage = "";
    let textColor = "#000000";

    if (gain < 0) {
      bgImage = "deadchannel.gif";
      textColor = "#ffffff";
    } else if (gain === 0) {
      bgImage = "ice.png";
      textColor = "#D6DDE7";
    } else if (gain <= 1500) {
      bgImage = "1000.png";
      textColor = "#9C4901";
    } else if (gain <= 3000) {
      bgImage = "red_light_fire.gif";
      textColor = "#ffffff";
    } else if (gain <= 6000) {
      bgImage = "yellowfire.gif";
      textColor = "#ffffcc";
    } else if (gain <= 12000) {
      bgImage = "greenfire.gif";
      textColor = "#ccffff";
    } else if (gain <= 25000) {
      bgImage = "blue_fire.gif";
      textColor = "#ffffff";
    } else {
      bgImage = "rainbow_fire.gif";
      textColor = "#ffffff";
    }

    if (rankBadge) {
      rankBadge.style.backgroundImage = `url('${bgImage}')`;
      rankBadge.style.backgroundSize = "cover";
      rankBadge.style.backgroundPosition = "center";
      rankBadge.style.backgroundRepeat = "no-repeat";
    }
    card.style.color = textColor;
  }
}

/**************************************
 * MAIN UPDATE LOOP
 * - uses random subset each tick to reduce lag
 **************************************/
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

async function updateMain() {
  if (isUpdatingMain) return;
  isUpdatingMain = true;
  try {
    const data = await fetchTop50Data();
    if (!data || !data.length) {
      isUpdatingMain = false;
      return;
    }

    // random subset for smoother, less heavy updates
    const allRanks = Array.from({ length: 50 }, (_, i) => i + 1);
    shuffle(allRanks);
    const subset = allRanks.slice(0, 15); // update 15 ranks per tick
    updateSnakeGrid(data, subset);
  } catch (e) {
    console.error("updateMain error:", e);
  }
  isUpdatingMain = false;
}

/**************************************
 * BOOTSTRAP EVERYTHING AFTER DOM READY
 **************************************/
document.addEventListener("DOMContentLoaded", () => {
  // 1) ensure all 50 cards exist
  ensureCards();

  // 2) init odometers for all 50
  initOdometers();

  // 3) first runs
  fetchStreamData();
  updateTicker();
  fetchFastest();
  updateMain();

  // 4) intervals (tuned for less lag)
  setInterval(fetchStreamData, 1000);   // top stats
  setInterval(updateTicker, 3000);      // ticker
  setInterval(fetchFastest, 5000);      // fastest bar
  setInterval(() => {
    showTopFive = !showTopFive;
    renderFastest();
  }, 30000);                            // swap top 5 / next 5
  setInterval(updateMain, 2200);        // main snake grid

  // 5) hourly hard reload (safety)
  setInterval(() => location.reload(), 3600000);
});
</script>


</body>
</html>
